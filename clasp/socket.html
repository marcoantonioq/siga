<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }

    h1 {
      color: #3498db;
      text-align: center;
      font-size: 1.5em;
      margin: 1rem 0;
    }

    .form-container {
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .flex {
      display: flex;
      align-items: center;
      justify-content: start;
    }

    label {
      font-weight: bold;
      color: #333;
      margin-bottom: 0.25rem;
      display: block;
    }

    input,
    button {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }

    input {
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    input:focus {
      border-color: #3498db;
      outline: none;
    }

    button {
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:disabled {
      background: #b0c4de;
      cursor: not-allowed;
    }

    .loader {
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text,
    .error {
      text-align: center;
      margin-top: 10px;
    }

    .error {
      color: red;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th,
    td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: left;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      width: 30px;
    }

    .count {
      display: inline-block;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      font-size: 12px;
    }

    .date-range-row {
      display: flex;
      gap: 10px;
    }

    .date-range-row .form-group {
      flex: 1;
    }

    .spinner {
      margin: 2px;
      width: 14px;
      height: 14px;
      border: 3px solid #ccc;
      border-top-color: #034208;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .form-container {
        padding: 0.5rem;
      }

      .date-range-row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="form-container">
      <template v-if="!app.wsConnected">
        <div class="flex center">
          Reconectando no servidor...</p>
          <span class="spinner"></span>
        </div>
      </template>
      <template v-else>
        <div class="date-range-row">
          <div class="form-group">
            <label>Data Inicial*:</label>
            <input type="date" v-model="form.date1" />
          </div>
          <div class="form-group">
            <label>Data Final*:</label>
            <input type="date" v-model="form.date2" :min="form.date1" />
          </div>
        </div>

        <div class="form-group">
          <label>Cookies*:</label>
          <div class="flex">
            <input type="text" v-model="form.auth.cookies" @blur="onCookiesBlur" placeholder="Digite os cookies" />
            <span class="spinner" v-show="app.loadingTable.login"></span>
          </div>
        </div>

        <div class="form-group" v-if="form.adms.length">
          <label>Unidades:</label>
          <table>
            <thead>
              <tr>
                <th>
                  <input type="checkbox" @change="form.adms.forEach(a => a.active = $event.target.checked)" />
                </th>
                <th>Descrição</th>
                <th>Igrejas</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="adm in form.adms" :key="adm.id" @click="adm.active = !adm.active" style="cursor: pointer">
                <td>
                  <input type="checkbox" v-model="adm.active" @click.stop />
                </td>
                <td>{{ adm.description }}</td>
                <td>
                  <div class="flex">
                    <span v-if="adm.loading" class="spinner"></span>
                    <span class="count"> {{ adm.igrejas.length }} </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="form-group">
          <label>Itens a carregar:</label>
          <table>
            <thead>
              <tr>
                <th>
                  <input type="checkbox" @change="form.options.forEach(o => o.active = $event.target.checked)" />
                </th>
                <th>Item</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="op in form.options" :key="op.id" @click="op.active = !op.active" style="cursor: pointer">
                <td>
                  <input type="checkbox" v-model="op.active" @click.stop />
                </td>
                <td>{{ op.label }}</td>
                <td>
                  <div class="flex">
                    <span v-if="app.loadingTable[op.id]" class="spinner"></span>
                    <button v-show="tables[op.id].length" type="button" @click.stop="copy(tables[op.id])">
                      Copiar {{tables[op.id].length}}
                    </button>
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <input type="checkbox" value="true" checked disabled />
                </td>
                <td>Igrejas</td>
                <td>
                  <button v-show="tables.igrejas.length" type="button" @click="copy(tables.igrejas)">
                    Copiar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <button @click="loadData" :disabled="app.loading" style="background-color: #27ae60">
          Carregar
        </button>

      </template>
    </div>
  </div>
  <script>
    const { createApp, ref, watch, computed, onMounted } = Vue;

    createApp({
      setup() {
        const app = ref({
          wsConnected: false,
          loading: false,
          loadingTable: {
            igrejas: false,
            eventos: false,
            fluxos: false,
            ofertas: false,
            dados: false,
            solicitacoes: false,
            login: false,
          },
        });
        const form = ref({
          auth: { cookies: '' },
          date1: '',
          date2: '',
          options: [
            { id: 'fluxos', label: 'Fluxos', active: false },
            { id: 'ofertas', label: 'Ofertas', active: false },
            { id: 'eventos', label: 'Eventos', active: false },
            { id: 'dados', label: 'Dados', active: false },
            { id: 'solicitacoes', label: 'Solicitações', active: false },
          ],
          adms: [],
        });
        const tables = ref({
          igrejas: [],
          eventos: [],
          fluxos: [],
          ofertas: [],
          dados: [],
          solicitacoes: [],
        });
        let socket;

        const options = computed(() =>
          form.value.options.filter((op) => op.active).map((op) => op.id)
        );

        function validarCampos() {
          if (
            !form.value.date1 ||
            !form.value.date2 ||
            !form.value.auth.cookies
          ) {
            show.warn('Preencha todos os campos obrigatórios.')
            return false;
          }
          if (form.value.date2 < form.value.date1) {
            show.warn('Data final não pode ser anterior à data inicial.');
            return false;
          }
          return true;
        }

        const show = {
          success(msg, sleep = 2000) {
            Toastify({
              text: msg,
              duration: sleep,
              gravity: 'top',
              position: 'center',
              style: { background: '#27ae60' },
            }).showToast();
          },
          warn(msg, sleep = 2000) {
            Toastify({
              text: msg,
              duration: sleep,
              gravity: 'top',
              position: 'center',
              style: { background: '#e74c3c' },
            }).showToast();
          }
        }

        async function loadData() {
          if (!validarCampos()) return;
          app.value.loading = true;
          try {
            await carregarIgrejas();
            for (const adm of form.value.adms) {
              if (!adm.active) continue;
              adm.loading = true;
              for (const igreja of adm.igrejas) {
                // if (!igreja.active) continue;
                igreja.loading = true;
                try {
                  if (igreja.IGREJA_TIPO === 3) {
                    await empresaAlterar({
                      igreja: igreja,
                      auth: form.value.auth,
                    });
                    show.success(`Carregando dados para ${igreja.IGREJA_DESC}...`, 2000);
                    await Promise.all([
                      await carregarEventosSecretaria(igreja),
                      await carregarFluxos(igreja),
                    ])
                    await carregarOfertas(igreja);
                  } else if (igreja.IGREJA_TIPO === 11) {
                    show.success(`Carregando dados para ${igreja.IGREJA_DESC}...`, 2000);
                    await empresaAlterar({
                      igreja: igreja,
                      auth: form.value.auth,
                    });
                    await carregarDados(igreja);
                    await carregarSolicitacoes(igreja);
                  }
                } catch (error) {
                  show.warn
                  console.error(
                    `Erro ao carregar dados para ${igreja.UNIDADE_COD}: ${error}`, 4000
                  );

                } finally {
                  igreja.loading = false;
                }
              }
              adm.loading = false;
            }
          } catch (err) {
            show.warn(`Erro: ${err.message || err}`, 4000)
          } finally {
            app.value.loading = false;
          }
        }

        function wsConnect() {
          return new Promise((resolve, reject) => {
            socket = io({ transports: ['websocket'] });
            socket.on('connected', async () => {
              app.value.wsConnected = true;
              app.value.loadingTable.login = true;
              try {
                await login();
                app.value.loadingTable.login = false;
                resolve();
              } catch (e) {
                show.warn('Erro ao realizar login: ' + e, 4000);
                app.value.loadingTable.login = false;
                reject(e);
              }
            });
            socket.on('disconnect', () => {
              app.value.wsConnected = false;
              app.value.loadingTable.login = false;
              show.warn('Desconectado do servidor.', 3000);
            });
            socket.on('connect_error', (err) => {
              show.warn('Erro de conexão: ' + err.message, 4000);
              app.value.loadingTable.login = false;
              reject(err);
            });
          });
        }

        function login() {
          app.value.loadingTable.login = true;
          return new Promise((res, rej) => {
            if (!form.value.auth.cookies)
              return rej('Cookies não informados.');
            app.value.loading = true;
            let toast;
            toast = Toastify({
              text: 'Realizando login...',
              duration: -1,
              gravity: 'top',
              position: 'center',
              style: { background: '#2980b9' },
              close: false,
              stopOnFocus: false,
            });
            toast.showToast();
            socket.emit(
              'login',
              { cookies: form.value.auth.cookies },
              async (data) => {
                app.value.loading = false;
                toast.hideToast();
                if (data.status) {
                  show.success('Login realizado com sucesso!', 2000);
                  app.value.loadingTable.login = false;
                  Object.assign(form.value.auth, data.data || {});
                  await carregarUnidades();

                  console.log('Carregando igrejas...');
                  await carregarIgrejas();
                  res(data);
                } else {
                  show.warn(data.message || 'Login falhou', 4000);
                  rej(data.message || 'Login falhou');
                }
              }
            );
          });
        }

        function carregarUnidades() {
          return new Promise((res) => {
            socket.emit('getUnidades', form.value.auth, (d) => {
              form.value.adms = d.data.map((a) => ({ ...a, active: false }));
              res();
            });
          });
        }

        function carregarIgrejas(empresas = form.value.adms) {
          return new Promise((res, rej) => {
            app.value.loadingTable.igrejas = true;
            socket.emit(
              'getIgrejas',
              { auth: form.value.auth, empresas },
              (d) => {
                app.value.loadingTable.igrejas = false;
                if (d.status) {
                  tables.value.igrejas = d.data;
                  form.value.adms.forEach((adm) => {
                    adm.igrejas = tables.value.igrejas.filter(
                      (i) => i.UNIDADE_COD === adm.id
                    );
                  });
                  res();
                } else rej(d.message);
              }
            );
          });
        }

        function empresaAlterar(payload) {
          return new Promise((res) =>
            socket.emit('empresaAlterar', payload, (d) => res(d))
          );
        }
        function carregarEventosSecretaria(adm) {
          return new Promise((res, rej) => {
            if (!options.value.includes('eventos')) return res();
            app.value.loadingTable.eventos = true;
            socket.emit(
              'carregarEventosSecretaria',
              {
                auth: form.value.auth,
                igreja: { ...adm, igrejas: [] },
                date1: form.value.date1,
                date2: form.value.date2,
              },
              (d) => {
                app.value.loadingTable.eventos = false;
                d.status
                  ? ((tables.value.eventos = d.data), res())
                  : rej(d.message);
              }
            );
          });
        }
        function carregarFluxos(adm) {
          return new Promise((res, rej) => {
            if (!options.value.includes('fluxos')) return res();
            app.value.loadingTable.fluxos = true;
            socket.emit(
              'fluxos',
              {
                auth: form.value.auth,
                empresa: { ...adm, igrejas: [] },
                date1: form.value.date1,
                date2: form.value.date2,
              },
              (d) => {
                app.value.loadingTable.fluxos = false;
                d.status
                  ? ((tables.value.fluxos = d.data), res())
                  : rej(d.message);
              }
            );
          });
        }
        function carregarOfertas(adm) {
          return new Promise((res, rej) => {
            if (!options.value.includes('ofertas')) return res();
            app.value.loadingTable.ofertas = true;
            socket.emit(
              'ofertas',
              {
                auth: form.value.auth,
                empresa: { ...adm, igrejas: [] },
                date1: form.value.date1,
                date2: form.value.date2,
              },
              (d) => {
                app.value.loadingTable.ofertas = false;
                d.status
                  ? ((tables.value.ofertas = d.data), res())
                  : rej(d.message);
              }
            );
          });
        }
        function carregarDados(adm) {
          return new Promise((res, rej) => {
            if (!options.value.includes('dados')) return res();
            app.value.loadingTable.dados = true;
            socket.emit(
              'dados',
              {
                auth: form.value.auth,
                empresa: { ...adm, igrejas: [] },
                date1: form.value.date1,
                date2: form.value.date2,
              },
              (d) => {
                app.value.loadingTable.dados = false;
                d.status
                  ? ((tables.value.dados = d.data), res())
                  : rej(d.message);
              }
            );
          });
        }
        function carregarSolicitacoes(adm) {
          return new Promise((res, rej) => {
            if (!options.value.includes('solicitacoes')) return res();
            app.value.loadingTable.solicitacoes = true;
            socket.emit(
              'solicitacoes',
              {
                auth: form.value.auth,
                empresa: adm,
                date1: form.value.date1,
                date2: form.value.date2,
              },
              (d) => {
                app.value.loadingTable.solicitacoes = false;
                d.status
                  ? ((tables.value.solicitacoes = d.data), res())
                  : rej(d.message);
              }
            );
          });
        }

        function carregarLocalStorage() {
          const saved = JSON.parse(localStorage.getItem('siga.data') || '{}');
          if (saved.auth?.cookies)
            form.value.auth.cookies = saved.auth.cookies;
          if (saved.date1) form.value.date1 = saved.date1;
          if (saved.date2) form.value.date2 = saved.date2;
          if (saved.options) form.value.options = saved.options;
        }

        const lastCookies = ref('');
        function onCookiesBlur() {
          if (form.value.auth.cookies !== lastCookies.value) {
            lastCookies.value = form.value.auth.cookies;
            login().catch((e) => {
              show.warn(`Erro ao realizar login: ${e}`, 4000);
            });
          }
        }

        function copy(data) {
          if (!Array.isArray(data) || !data.length) {
            show.warn('Nada para copiar!', 2000);
            return;
          }
          const keys = Object.keys(data[0]);
          const header = keys.join('\t');
          const rows = data.map((row) =>
            keys.map((k) => String(row[k] ?? '')).join('\t')
          );
          const tsv = [header, ...rows].join('\n');
          navigator.clipboard
            .writeText(tsv)
            .then(() => {
              show.success('Dados copiados para a área de transferência!', 2000);
            })
            .catch(() => {
              show.warn('Erro ao copiar os dados!', 2000);
            });
        }

        watch(
          form,
          (v) => localStorage.setItem('siga.data', JSON.stringify(v)),
          { deep: true }
        );

        onMounted(() => {
          carregarLocalStorage();
          wsConnect();
        });

        return {
          form,
          app,
          tables,
          options,
          loadData,
          onCookiesBlur,
          copy,
        };
      },
    }).mount('#app');
  </script>
</body>

</html>